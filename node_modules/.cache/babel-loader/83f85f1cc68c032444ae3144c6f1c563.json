{"ast":null,"code":"import _regeneratorRuntime from\"/Users/bluevisionai/Desktop/untitled folder/untitled folder/gitdagray/binpack-16-03-23/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/Users/bluevisionai/Desktop/untitled folder/untitled folder/gitdagray/binpack-16-03-23/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/Users/bluevisionai/Desktop/untitled folder/untitled folder/gitdagray/binpack-16-03-23/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _objectSpread from\"/Users/bluevisionai/Desktop/untitled folder/untitled folder/gitdagray/binpack-16-03-23/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{createContext,useEffect,useReducer}from'react';import jwtDecode from'jwt-decode';import axios from'app/api/axios.js';import{MatxLoading}from'app/components';import{jsx as _jsx}from\"react/jsx-runtime\";var initialState={isAuthenticated:false,isInitialised:false,user:null};var isValidToken=function isValidToken(accessToken){if(!accessToken){return false;}var decodedToken=jwtDecode(accessToken);var currentTime=Date.now()/1000;return decodedToken.exp>currentTime;};var setSession=function setSession(accessToken){if(accessToken){localStorage.setItem('accessToken',accessToken);axios.defaults.headers.common.Authorization=\"Bearer \".concat(accessToken);}else{localStorage.removeItem('accessToken');delete axios.defaults.headers.common.Authorization;}};// const removeSession = () => {\n//         localStorage.removeItem('accessToken')\n//         delete axios.defaults.headers.common.Authorization\n// }\nvar reducer=function reducer(state,action){switch(action.type){case'INIT':{var _action$payload=action.payload,isAuthenticated=_action$payload.isAuthenticated,user=_action$payload.user;return _objectSpread(_objectSpread({},state),{},{isAuthenticated:isAuthenticated,isInitialised:true,user:user});}case'LOGIN':{var _user=action.payload.user;return _objectSpread(_objectSpread({},state),{},{isAuthenticated:true,user:_user});}case'LOGOUT':{return _objectSpread(_objectSpread({},state),{},{isAuthenticated:false,user:null});}case'REGISTER':{var _user2=action.payload.user;return _objectSpread(_objectSpread({},state),{},{isAuthenticated:true,user:_user2});}default:{return _objectSpread({},state);}}};var AuthContext=/*#__PURE__*/createContext(_objectSpread(_objectSpread({},initialState),{},{method:'JWT',login:function login(){return Promise.resolve();},logout:function logout(){},register:function register(){return Promise.resolve();}}));export var AuthProvider=function AuthProvider(_ref){var children=_ref.children;var _useReducer=useReducer(reducer,initialState),_useReducer2=_slicedToArray(_useReducer,2),state=_useReducer2[0],dispatch=_useReducer2[1];var login=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(accessToken,user){return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:// \n// console.log(\"login: \" + email+ \" \" + password);\n// // \n// const response = await axios.post('/auth', {\n//     email,\n//     password,\n// })\n// const { accessToken, user } = response.data\n// \n// console.log(\"response.data: \" + response.data);\n// console.log(\"accessToken: \" + accessToken);\n// console.log(\"user: \" + user);\n// console.log(\"user: \" + response.data.user.email);\n// \nsetSession(accessToken);dispatch({type:'LOGIN',payload:{user:user}});return _context.abrupt(\"return\",true);case 3:case\"end\":return _context.stop();}}},_callee);}));return function login(_x,_x2){return _ref2.apply(this,arguments);};}();var register=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(email,username,password){var response,_response$data,accessToken,user;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return axios.post('/users',{email:email,password:password});case 2:response=_context2.sent;_response$data=response.data,accessToken=_response$data.accessToken,user=_response$data.user;setSession(accessToken);dispatch({type:'REGISTER',payload:{user:user}});case 6:case\"end\":return _context2.stop();}}},_callee2);}));return function register(_x3,_x4,_x5){return _ref3.apply(this,arguments);};}();var logout=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(){var response;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:setSession(null);_context3.next=3;return axios.post('/auth/logout',{headers:{'Content-Type':'application/json'},withCredentials:true});case 3:response=_context3.sent;console.log(\"LOGOUT response: \"+response);dispatch({type:'LOGOUT'});case 6:case\"end\":return _context3.stop();}}},_callee3);}));return function logout(){return _ref4.apply(this,arguments);};}();useEffect(function(){;_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee4(){var accessToken,response,user;return _regeneratorRuntime().wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.prev=0;accessToken=window.localStorage.getItem('accessToken');console.log(\"isValidToken-accessToken: \"+accessToken);if(!(accessToken&&isValidToken(accessToken))){_context4.next=16;break;}setSession(accessToken);console.log(\"isValidToken-accessToken: \"+accessToken);_context4.next=8;return axios.get('/auth/refresh',{headers:{'Content-Type':'application/json'},Authorization:\"Bearer \".concat(accessToken),withCredentials:true});case 8:response=_context4.sent;console.log(\"response: \"+response.data);user=response.data.user;console.log(\"/refresh: \"+user);console.log(\"isValidToken-user: \"+user);dispatch({type:'INIT',payload:{isAuthenticated:true,user:user}});_context4.next=17;break;case 16:dispatch({type:'INIT',payload:{isAuthenticated:false,user:null}});case 17:_context4.next=23;break;case 19:_context4.prev=19;_context4.t0=_context4[\"catch\"](0);console.error(_context4.t0);dispatch({type:'INIT',payload:{isAuthenticated:false,user:null}});case 23:case\"end\":return _context4.stop();}}},_callee4,null,[[0,19]]);}))();},[]);if(!state.isInitialised){return/*#__PURE__*/_jsx(MatxLoading,{});}return/*#__PURE__*/_jsx(AuthContext.Provider,{value:_objectSpread(_objectSpread({},state),{},{method:'JWT',login:login,logout:logout,register:register}),children:children});};export default AuthContext;","map":null,"metadata":{},"sourceType":"module"}